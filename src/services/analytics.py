# src/services/analytics.py

from typing import List
from src.database.models import Listing
from src.llm.prompt_engine import SearchPromptEngine


class AnalyticsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —É—á–∞—Å—Ç–∫–æ–≤ —á–µ—Ä–µ–∑ LLM"""

    @staticmethod
    def generate_analysis_prompt(listing: Listing) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM ‚Äî –∞–Ω–∞–ª–∏–∑ —É—á–∞—Å—Ç–∫–∞.
        """
        return f"""
–í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–µ–º–µ–ª—å–Ω—ã–º —É—á–∞—Å—Ç–∫–∞–º –≤ –ü–æ–¥–º–æ—Å–∫–æ–≤—å–µ.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —É—á–∞—Å—Ç–æ–∫:

- –†–∞–π–æ–Ω: {listing.district_code or '–ù–µ —É–∫–∞–∑–∞–Ω'}
- –¶–µ–Ω–∞: {int(listing.start_price):,} ‚ÇΩ
- –ü–ª–æ—â–∞–¥—å: {int(listing.total_square)} –º¬≤
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: {listing.land_allowed_use_name or '‚Äî'}
- –¢–∏–ø: {listing.purchase_kind_name or '‚Äî'}
- –°—Ç–∞—Ç—É—Å: {listing.stage_state_name or '‚Äî'}
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {listing.latitude}, {listing.longitude}

–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π, –Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:

‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–¥–æ 3 –ø—É–Ω–∫—Ç–æ–≤)  
‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ (–¥–æ 3 –ø—É–Ω–∫—Ç–æ–≤)  
üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (—á—Ç–æ –¥–µ–ª–∞—Ç—å: –ø–æ–∫—É–ø–∞—Ç—å, –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å, –∂–¥–∞—Ç—å)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤.
""".strip()

    @staticmethod
    def generate_comparison_prompt(listings: List[Listing]) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤.
        """
        items = []
        for i, listing in enumerate(listings, 1):
            items.append(
                f"{i}. –†–∞–π–æ–Ω: {listing.district_code or '‚Äî'}, –¶–µ–Ω–∞: {int(listing.start_price):,} ‚ÇΩ, "
                f"–ü–ª–æ—â–∞–¥—å: {int(listing.total_square)} –º¬≤, –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: {listing.land_allowed_use_name or '‚Äî'}"
            )

        return f"""
–í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∑–µ–º–µ–ª—å–Ω—ã–º —É—á–∞—Å—Ç–∫–∞–º.

–°—Ä–∞–≤–Ω–∏—Ç–µ —ç—Ç–∏ {len(listings)} —É—á–∞—Å—Ç–∫–∞:

{chr(10).join(items)}

–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:

ü•á –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—é —Ü–µ–Ω–∞/–ø–ª–æ—â–∞–¥—å/—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ)  
üìä –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è  
üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å –∏ –ø–æ—á–µ–º—É

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
""".strip()